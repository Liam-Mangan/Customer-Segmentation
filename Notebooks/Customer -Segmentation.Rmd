---
title: "Customer-Segmentation"
author: "Liam Mangan"
date: "2025-08-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r Library}
# Load libraries
library(tidyverse)   
library(cluster)    
library(factoextra) 
library(dplyr)    
library(ggplot2)
library(GGally)
library(scales)
```


```{r Data}
# Load data (adjust path if needed)
data <- read.csv("../data/marketing_campaign.csv")

summary(data)
colSums(is.na(data))

```

```{r cleaning}
#Removing missing values
data <- data %>% 
  filter(!is.na(Income))
#colSums(is.na(data))
# Updating categorical columns
data$Education <- as.factor(data$Education)
data$Marital_Status <- as.factor(data$Marital_Status)

# Converting birth year to age 
current_year <- as.numeric(format(Sys.Date(), "%Y"))

data <- data %>%
  mutate(Age = current_year - Year_Birth) 

# Adjusting age range
data <- data %>%
  filter(Age >= 18 & Age <= 100)

# Select features for clustering
cluster_data <- data %>%
  select(
    Age, Income, Education, Marital_Status, 
    MntWines, MntFruits, MntMeatProducts, MntFishProducts,
    MntSweetProducts, MntGoldProds, NumDealsPurchases, NumWebPurchases,
    NumCatalogPurchases, NumStorePurchases, NumWebVisitsMonth, Kidhome,
    Teenhome
  )

# Convert categorical variables to numeric
cluster_data$Education <- as.numeric(cluster_data$Education)
cluster_data$Marital_Status<- as.numeric(cluster_data$Marital_Status)
# Scale the data for clustering
cluster_data_scaled <- scale(cluster_data)

# Cleaned and scaled data
head(cluster_data_scaled)
```
```{r Data analysis}
# Age distribution
ggplot(data, aes(x = Age)) +
  geom_histogram(fill = "steelblue", bins = 30) +
  labs(title = "Age Distribution", x = "Age", y = "Count")

# Income Distribution
removed_outliers <- data %>%
  filter(Income <= 200000)

ggplot(removed_outliers, aes(x = Income)) +
  geom_histogram(fill = "darkgreen", bins = 30, color = "white") +
  scale_x_continuous(labels = comma, limits =
  c(min(removed_outliers$Income, na.rm = TRUE), 
  max(removed_outliers$Income, na.rm =TRUE))) +
  labs(title = "Income Distribution", x = "Income", y = "Count", caption = "Outlier at $666,000") +
  theme_minimal()

# Income by Education 
ggplot(removed_outliers, aes(x = Education, y = Income)) +
  geom_boxplot(fill = "lightblue") +
  scale_y_continuous(labels = comma, limits =
  c(min(removed_outliers$Income, na.rm = TRUE), 
  max(removed_outliers$Income, na.rm = TRUE))) +
  labs(title = "Income by Education Level", x = "Education Level", y =
  "Income", caption = "Outlier of $666,000 removed from gradution") +
  theme_minimal()

# Marital Status counts
ggplot(data, aes(x = Marital_Status)) +
  geom_bar(fill = "orange") +
  labs(title = "Marital Status Count", x = "Marital Status", y ="Count")

# Spending Behavior 
spending_vars <- c("MntWines","MntFruits","MntMeatProducts","MntFishProducts", "MntSweetProducts","MntGoldProds")

# Histograms for spending variables
data %>%
  select(all_of(spending_vars)) %>%
  gather(key = "Category", value = "Amount") %>%
  ggplot(aes(x = Amount)) +
  geom_histogram(fill = "purple", bins = 30) +
  facet_wrap(~Category, scales = "free") +
  labs(title = "Spending Distribution by Category", x = "Amount Spent", y = "Count")

# Engagement Metrics 
engagement_vars <- c("NumDealsPurchases","NumWebPurchases","NumCatalogPurchases", "NumStorePurchases","NumWebVisitsMonth")

data %>%
  select(all_of(engagement_vars)) %>%
  gather(key = "EngagementMetric", value = "Count") %>%
  ggplot(aes(x = Count)) +
  geom_histogram(fill = "darkred", bins = 30) +
  facet_wrap(~EngagementMetric, scales = "free") +
  labs(title = "Engagement Metrics Distribution", x = "Count", y = "Frequency")

#  Correlation Matrix
numeric_vars <- cluster_data_scaled  # scaled numeric variables for clustering
cor_matrix <- cor(numeric_vars)
library(corrplot)
corrplot(cor_matrix, method = "color", type = "upper", tl.cex = 0.7)

```

```{r Clustering}
Clustering_data <- removed_outliers %>% 
  select(Age, Income, MntWines, MntFruits, MntMeatProducts,
         MntFishProducts, MntSweetProducts, MntGoldProds,
         NumDealsPurchases, NumWebPurchases, 
         NumCatalogPurchases, NumStorePurchases)
scaled_clustering <- scale(Clustering_data)
# K-means Clustering
wss <- vector()
# Elbow plot 
for (i in 1:10) {
  km <- kmeans(scaled_clustering, centers = i, nstart = 25)
  wss[i] <- km$tot.withinss
}

plot(1:10, wss, type = "b", pch = 19, frame = FALSE,
     xlab = "Number of Clusters (k)",
     ylab = "Total Within-Cluster Sum of Squares",
     main = "Elbow Method for K-means")

set.seed(2025)
km_result <- kmeans(scaled_clustering, centers = 3, nstart = 25)

#Labeling
removed_outliers$Cluster <- as.factor(km_result$cluster)

#Visualizing clusters 
fviz_cluster(km_result, data = scaled_clustering,
             geom = "point", stand = FALSE,
             ellipse.type = "norm", 
             main = "Customer Segments (K-means)")

#Customer Profile
cluster_profiles <- removed_outliers %>%
  group_by(Cluster) %>%
  summarise(across(c(Age, Income, MntWines:MntGoldProds,
                     NumDealsPurchases:NumStorePurchases), 
                   mean, na.rm = TRUE))

print(cluster_profiles)
```

```{r}
# Creating cluster profiles 
cluster_profiles <- removed_outliers %>%
  group_by(Cluster) %>%
  summarise(
    Age = mean(Age, na.rm = TRUE),
    Income = mean(Income, na.rm = TRUE),
    NumDealsPurchases = mean(NumDealsPurchases, na.rm = TRUE),
    Kidhome = round(mean(Kidhome, na.rm = TRUE), 1),
    Marital_Status = names(sort(table(Marital_Status), decreasing = TRUE))[1],
    across(MntWines:MntGoldProds, mean, na.rm = TRUE),
    across(NumWebPurchases:NumStorePurchases, mean, na.rm = TRUE)
  ) %>%
  ungroup()
# Coupon usage
coupon_threshold <- median(removed_outliers$NumDealsPurchases, na.rm = TRUE)

cluster_profiles <- cluster_profiles %>%
  mutate(CouponUsage = case_when(
    NumDealsPurchases >= coupon_threshold ~ "Frequent coupon users",
    TRUE ~ "Occasional coupon users"
  ))
# Household 
cluster_profiles <- cluster_profiles %>%
  mutate(
    Household = case_when(
      Kidhome == 0 ~ paste(Marital_Status, "- no kids"),
      Kidhome > 0 ~ paste(Marital_Status, "-", Kidhome, "kid(s)"),
      TRUE ~ Marital_Status
    )
  )
#Automating cluster profile write up
for (c in unique(removed_outliers$Cluster)) {
  profile <- cluster_profiles %>% filter(Cluster == c)
  
  cat(paste0("Cluster ", c, ":\n"))
  cat(paste0(" - Average age: ", round(profile$Age, 1), "\n"))
  cat(paste0(" - Average income: $", scales::comma(round(profile$Income, 0)), "\n"))
  cat(paste0(" - Coupon behavior: ", profile$CouponUsage, "\n"))
  cat(paste0(" - Household: ", profile$Household, "\n"))
  cat(" - Spending highlights:\n")
  
  # Top 2 product categories
  top_spend <- profile %>% 
    select(MntWines:MntGoldProds) %>%
    pivot_longer(everything()) %>%
    arrange(desc(value)) %>%
    slice(1:2)
  
  for (i in 1:nrow(top_spend)) {
    cat(paste0("   â€¢ ", top_spend$name[i], ": ", round(top_spend$value[i], 1), "\n"))
  }
  
  cat("\n")
}

```